<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LimLink Opt-In</title>
</head>
<body>
  <h2 id="status">Processing your preference...</h2>
  <div id="response_message"></div>

  <script>
    const publicVapidKey = BGi1QHhmXiT3YZyJFpJ4_9VswYNVB8Vx96yrsEiQ3j-n6jRHIleNrGolgSiqaKwzJt05v7wcScKUeUjznk72gag
; // replace with yours

    async function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }

    async function submitOptInAndRegister() {
      const status = document.getElementById('status');
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('data');

      if (!dataParam) {
        status.textContent = '‚ùå Invalid or missing QR data.';
        status.style.color = 'red';
        return;
      }

      let data;
      try {
        data = JSON.parse(dataParam);
      } catch (err) {
        status.textContent = '‚ùå Invalid JSON format.';
        status.style.color = 'red';
        return;
      }

      try {
        // Step 1 ‚Äî Submit opt-in to backend
        const res = await fetch('/api/optin_sms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (!res.ok) {
          throw new Error(result.error || 'Error saving opt-in.');
        }

        // Step 2 ‚Äî If opted in, register for push
        if (data.response === true) {
          status.textContent = '‚úÖ Registered for SMS. Setting up push offers...';
          status.style.color = 'green';

          // Ask for push notification permission
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            status.textContent = '‚ö†Ô∏è Push notifications blocked.';
            return;
          }

          // Register service worker
          const reg = await navigator.serviceWorker.register('/sw.js');

          // Subscribe
          const subscription = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: await urlBase64ToUint8Array(publicVapidKey)
          });

          // Save subscription
          await fetch('/api/push_subscriptions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscription)
          });

          status.textContent = 'üéâ You are fully registered for offers and updates!';
          status.style.color = 'green';
        } else {
          status.textContent = '‚úÖ Opt-out recorded. No notifications will be sent.';
          status.style.color = 'orange';
        }
      } catch (err) {
        console.error(err);
        status.textContent = '‚ùå Submission failed.';
        status.style.color = 'red';
      }
    }

    submitOptInAndRegister();
  </script>
</body>
</html>
